const LastPageCheckRule = require('./last-page-check-rule');
const FeedLog = require('../../feed-log');
const RpdeNode = require('../../rpde-node');
const RpdeErrorType = require('../../errors/rpde-error-type');

describe('LastPageCheckRule', () => {
  let log;
  let rule;
  let json;
  const url = 'http://example.org/feed';

  beforeEach(() => {
    log = new FeedLog();
    spyOn(log, 'addPageError').and.callThrough();
    json = {
      lastTimestamp: null,
      lastId: null,
      lastChangeNumber: null,
    };
    rule = new LastPageCheckRule();
  });

  it('should raise no error when there is a valid numeric string lastTimestamp', () => {
    json.lastTimestamp = '12345';
    const node = new RpdeNode(
      url,
      json,
      log,
    );

    rule.validate(node);

    expect(log.addPageError).not.toHaveBeenCalled();
  });

  it('should raise no error when there is a valid numeric lastTimestamp', () => {
    json.lastTimestamp = 12345;
    const node = new RpdeNode(
      url,
      json,
      log,
    );

    rule.validate(node);

    expect(log.addPageError).not.toHaveBeenCalled();
  });

  it('should raise an error when the lastTimestamp is a non-numeric string', () => {
    json.lastTimestamp = '2018-05-01T00:00:00';
    const node = new RpdeNode(
      url,
      json,
      log,
    );

    rule.validate(node);

    expect(log.addPageError).toHaveBeenCalled();
    expect(log.pages.length).toBe(1);
    expect(log.pages[0].errors.length).toBe(1);
    expect(log.pages[0].errors[0].type).toBe(RpdeErrorType.NO_LAST_PAGE_CHECK);
  });

  it('should raise no error when there is a valid numeric string lastChangeNumber', () => {
    json.lastChangeNumber = '12345';
    const node = new RpdeNode(
      url,
      json,
      log,
    );

    rule.validate(node);

    expect(log.addPageError).not.toHaveBeenCalled();
  });

  it('should raise no error when there is a valid numeric lastChangeNumber', () => {
    json.lastChangeNumber = 12345;
    const node = new RpdeNode(
      url,
      json,
      log,
    );

    rule.validate(node);

    expect(log.addPageError).not.toHaveBeenCalled();
  });

  it('should raise an error when the lastChangeNumber is a non-numeric string', () => {
    json.lastChangeNumber = 'ABC123';
    const node = new RpdeNode(
      url,
      json,
      log,
    );

    rule.validate(node);

    expect(log.addPageError).toHaveBeenCalled();
    expect(log.pages.length).toBe(1);
    expect(log.pages[0].errors.length).toBe(1);
    expect(log.pages[0].errors[0].type).toBe(RpdeErrorType.NO_LAST_PAGE_CHECK);
  });

  it('should raise an error when the both lastChangeNumber and lastTimestamp are null', () => {
    const node = new RpdeNode(
      url,
      json,
      log,
    );

    rule.validate(node);

    expect(log.addPageError).toHaveBeenCalled();
    expect(log.pages.length).toBe(1);
    expect(log.pages[0].errors.length).toBe(1);
    expect(log.pages[0].errors[0].type).toBe(RpdeErrorType.NO_LAST_PAGE_CHECK);
  });
});
